<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Processing Benchmark - 60k Posts</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 40px 20px;
            background-color: #fff;
        }
        .container {
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 20px;
        }
        h2 {
            font-size: 24px;
            margin-top: 40px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        #loops {
            max-width: 800px;
        }
        .latencySVG {
            width: 100%;
            filter: drop-shadow(rgba(0, 0, 0, 0.145) 0px 1px 5px);
        }
        pre {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 14px;
            line-height: 1.4;
        }
        ul {
            padding-left: 20px;
        }
        li {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>

<div class="container">
    <br>
    <h1>Data Processing Benchmark (60k Posts)</h1>
    <p>Top 5 related posts generation based on shared tags.</p>
    <br>
    
    <!-- This div holds the SVG generated by the script -->
    <div id="loops"></div>

    <br><br><br>

    <h2>Methodology</h2>
    <p>
        Timings taken on an AWS c7a.xlarge (4vCPU, 8GB RAM). 
        The benchmark processes a JSON dataset of 60,000 posts and calculates relationships.
    </p>
    <ul>
        <li><strong>Julia HO:</strong> Highly optimized version using specialized data structures.</li>
        <li><strong>D HO:</strong> Highly optimized version.</li>
        <li><strong>JS runtimes:</strong> Comparison between Bun, Node, and Deno.</li>
        <li><strong>Legacy:</strong> Python and Ruby showing interpreted overhead.</li>
    </ul>

    <h2>Raw Output (60k Dataset)</h2>
    <pre>
Language          Time
Julia HO          99.33 ms
D HO              122.06 ms
Rust              1.30 s
Zig               1.99 s
Go                3.48 s
Swift             4.19 s
JS (Bun)          8.49 s
JS (Node)         11.03 s
Python            215.18 s
Ruby              254.93 s
    </pre>
</div>

<script>
class LatencyVisual {
  constructor(id, timings) {
    this.timings = timings;
    for (const timing of timings) {
      timing.class = id + '-' + timing.class;
    }

    this.slowdown = 1500;
    this.totalTime = 1000000;
    this.id = id;
    this.dom = document.getElementById(this.id);
    this.initializeBaseElements();
    
    this.updateSizes();
    this.initialize();
   
    setTimeout((() => { 
      for (const t of this.timings) {
        // timeFor determines the speed of the bounce
        t.timeFor = t.seconds * this.slowdown;
        this.animate(`.${t.class}Rect`, t);
      }
    }).bind(this), 500);
  }

  initializeBaseElements() {
    const container = d3.select('#' + this.id);
    this.svg = container.append('svg')
      .attr('class', 'latencySVG')
      .attr('viewBox', `0 0 800 ${this.timings.length * 40 + 50}`)
  }
  
  updateSizes() {
    this.width = 800;
    this.height = this.timings.length * 40 + 50;
    this.fontSize = 24;
    this.strokeWidth = 1;
    
    this.W = 320; // Width of the moving bar
    this.H = 36.36; // Height of each bar
    this.BX = 1;
    this.EX = this.width - this.W - 1;
    this.D = this.EX - this.BX;
    this.X = this.width * 0.5 - this.W / 2;

    let spacing = 37.5;
    this.timings.forEach((timing, i) => {
      timing.y = 20 + (i * spacing);
      timing.cx = this.BX;
      timing.prevT = 0;
      timing.forward = true;
      timing.begin = this.BX;
      timing.end = this.EX;
    });
  }

  drawBox(timing, x, w, h) {
    this.svg.select(`.${timing.class}Rect`)
      .attr('fill', timing.color)
      .attr('x', this.BX)
      .attr('y', timing.y)
      .style('filter', 'drop-shadow(rgba(0, 0, 0, 0.314) 1px 1px 3px)')
      .attr('width', w)
      .attr('height', h);

    this.svg.select(`.${timing.class}`)
      .attr('fill', '#ffffff')
      .attr('x', x)
      .attr('y', timing.y)
      .style('filter', 'drop-shadow(rgba(0, 0, 0, 0.145) 2px 2px 2px)')
      .attr('opacity', 0.85)
      .attr('width', w)
      .attr('height', h);

    this.svg.select(`.${timing.class}Label`)
      .text(`${timing.label} (${timing.displayTime})`)
      .style('font-size', '24px')
      .style('font-weight', '700')
      .attr('dominant-baseline', 'middle')
      .attr('fill', '#444')
      .attr('x', x + 54)
      .attr('y', timing.y + h/2 + 2);

    this.svg.select(`.${timing.class}Image`)
      .attr('href', timing.image)
      .attr('x', x + 9)
      .attr('y', timing.y)
      .style('filter', 'drop-shadow(rgba(0, 0, 0, 0.314) 2px 2px 2px)')
      .attr('width', 26.36)
      .attr('height', h);
  }
  
  initialize() {
    const mainG = this.svg.append('g').attr('class', 'IOsPerSecond');
    const diagram = mainG.append('g').attr('class', 'diagram');

    diagram.append('rect')
      .attr('class', 'background')
      .attr('fill', '#eee')
      .attr('stroke', '#aaa')
      .attr('stroke-width', 1)
      .attr('x', 1)
      .attr('y', 1)
      .attr('width', 798)
      .attr('height', this.height - 2);
    
    for (let timing of this.timings) {
      diagram.append('rect').attr('class', timing.class + 'Rect');
      diagram.append('rect').attr('class', timing.class);
      diagram.append('text').attr('class', timing.class + 'Label');
      diagram.append('image').attr('class', timing.class + 'Image');
      this.drawBox(timing, this.X, this.W, this.H);
    } 
  }

  animate(selector, stash) {
    let b = this.svg.select(selector);
    b.transition().ease(d3.easeLinear).duration(this.totalTime)
      .attrTween('x', () => {
        return (t) => {
          const elapsedMS = (t * this.totalTime) - stash.prevT;
          // Physics: Bars move based on their real performance
          // We cap the speed of the fastest ones so they remain visible
          let effectiveTime = Math.max(0.1, stash.seconds);
          let travelDist = this.D * (elapsedMS / (effectiveTime * this.slowdown));

          if (!stash.forward) travelDist = -travelDist;
          stash.cx += travelDist;

          if (stash.forward && stash.cx > stash.end) {
            stash.forward = false;
            stash.cx -= (stash.cx - stash.end);
          } else if (!stash.forward && stash.cx < stash.begin) {
            stash.forward = true;
            stash.cx += (stash.begin - stash.cx);
          }

          stash.prevT = (t * this.totalTime);
          return stash.cx;
        };
      });
  }
}

// Data mapping with logos and brand colors
const benchmarkData = [
  { label: 'Julia HO', displayTime: '99ms', seconds: 0.09, class: 'julia', color: '#9558B2', image: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/julia/julia-original.svg' },
  { label: 'D HO', displayTime: '122ms', seconds: 0.12, class: 'dlang', color: '#ba3f3e', image: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/dlang/dlang-original.svg' },
  { label: 'Rust', displayTime: '1.30s', seconds: 1.30, class: 'rust', color: '#000000', image: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/rust/rust-original.svg' },
  { label: 'Zig', displayTime: '1.99s', seconds: 1.99, class: 'zig', color: '#f7a41d', image: 'https://raw.githubusercontent.com/ziglang/logo/master/zig-logo-dark.svg' },
  { label: 'Java', displayTime: '2.62s', seconds: 2.62, class: 'java', color: '#ed8b00', image: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/java/java-original.svg' },
  { label: 'Go', displayTime: '3.48s', seconds: 3.48, class: 'go', color: '#00add8', image: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/go/go-original-wordmark.svg' },
  { label: 'Swift', displayTime: '4.19s', seconds: 4.19, class: 'swift', color: '#f05138', image: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/swift/swift-original.svg' },
  { label: 'Bun', displayTime: '8.49s', seconds: 8.49, class: 'bun', color: '#fbf0e9', image: 'https://bun.sh/logo.svg' },
  { label: 'Node', displayTime: '11.03s', seconds: 11.03, class: 'node', color: '#339933', image: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/nodejs/nodejs-original.svg' },
  { label: 'Python', displayTime: '215s', seconds: 215.18, class: 'python', color: '#3776ab', image: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/python/python-original.svg' },
  { label: 'Ruby', displayTime: '254s', seconds: 254.93, class: 'ruby', color: '#cc342d', image: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/ruby/ruby-original.svg' }
];

// Initialize the visual
new LatencyVisual('loops', benchmarkData);
</script>

</body>
</html>
